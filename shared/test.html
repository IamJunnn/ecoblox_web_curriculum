<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared Utilities Test</title>
  <link rel="stylesheet" href="css/variables.css">
  <style>
    body {
      font-family: var(--font-primary);
      padding: var(--spacing-8);
      background-color: var(--color-gray-50);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--color-white);
      padding: var(--spacing-6);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
    }

    h1 {
      color: var(--color-primary);
      margin-bottom: var(--spacing-6);
    }

    .test-section {
      margin-bottom: var(--spacing-6);
      padding: var(--spacing-4);
      background-color: var(--color-gray-50);
      border-radius: var(--border-radius-md);
    }

    .test-section h2 {
      color: var(--color-gray-700);
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-3);
    }

    .test-result {
      padding: var(--spacing-2) var(--spacing-3);
      margin-bottom: var(--spacing-2);
      border-radius: var(--border-radius-sm);
      font-family: var(--font-mono);
      font-size: var(--font-size-sm);
    }

    .test-pass {
      background-color: var(--color-success-bg);
      color: var(--color-success);
      border-left: 3px solid var(--color-success);
    }

    .test-fail {
      background-color: var(--color-danger-bg);
      color: var(--color-danger);
      border-left: 3px solid var(--color-danger);
    }

    .summary {
      padding: var(--spacing-4);
      background-color: var(--color-primary-bg);
      border-radius: var(--border-radius-md);
      margin-top: var(--spacing-6);
      text-align: center;
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Shared Utilities Test Suite</h1>
    <p>Testing all shared modules to verify they work correctly.</p>

    <div id="test-results"></div>
    <div id="summary" class="summary"></div>
  </div>

  <script type="module">
    import { API_CONFIG, ROLES, RANK_THRESHOLDS, SESSION_KEY } from './js/constants.js';
    import {
      getSession,
      saveSession,
      clearSession,
      isLoggedIn,
      getUserRole,
      hasRole
    } from './js/session.js';
    import {
      formatRelativeTime,
      formatDateTime,
      calculateRank,
      calculateProgressPercentage,
      isValidEmail,
      isValidPIN,
      capitalize
    } from './js/utils.js';

    const results = [];

    function test(name, fn) {
      try {
        const result = fn();
        if (result) {
          results.push({ name, pass: true });
          return true;
        } else {
          results.push({ name, pass: false, error: 'Test returned false' });
          return false;
        }
      } catch (error) {
        results.push({ name, pass: false, error: error.message });
        return false;
      }
    }

    function displayResults() {
      const container = document.getElementById('test-results');
      const summaryDiv = document.getElementById('summary');

      let html = '';
      let passCount = 0;

      // Group tests by module
      const modules = {
        'Constants': [],
        'Session Management': [],
        'Utilities': []
      };

      results.forEach(result => {
        if (result.name.includes('Constants')) {
          modules['Constants'].push(result);
        } else if (result.name.includes('Session')) {
          modules['Session Management'].push(result);
        } else {
          modules['Utilities'].push(result);
        }

        if (result.pass) passCount++;
      });

      // Display by module
      for (const [moduleName, tests] of Object.entries(modules)) {
        if (tests.length > 0) {
          html += `<div class="test-section">`;
          html += `<h2>${moduleName}</h2>`;

          tests.forEach(result => {
            const className = result.pass ? 'test-pass' : 'test-fail';
            const icon = result.pass ? '‚úÖ' : '‚ùå';
            const message = result.pass ? 'PASS' : `FAIL: ${result.error}`;
            html += `<div class="test-result ${className}">${icon} ${result.name}: ${message}</div>`;
          });

          html += `</div>`;
        }
      }

      container.innerHTML = html;

      // Summary
      const total = results.length;
      const failCount = total - passCount;
      const percentage = Math.round((passCount / total) * 100);

      if (failCount === 0) {
        summaryDiv.innerHTML = `üéâ All ${total} tests passed! (${percentage}%)`;
        summaryDiv.style.backgroundColor = 'var(--color-success-bg)';
        summaryDiv.style.color = 'var(--color-success)';
      } else {
        summaryDiv.innerHTML = `‚ö†Ô∏è ${passCount}/${total} tests passed (${percentage}%) - ${failCount} failed`;
        summaryDiv.style.backgroundColor = 'var(--color-warning-bg)';
        summaryDiv.style.color = 'var(--color-warning)';
      }
    }

    // ===========================
    // RUN TESTS
    // ===========================

    console.log('üß™ Starting Shared Utilities Test Suite...\n');

    // Constants Tests
    test('Constants: API_CONFIG exists', () => {
      return typeof API_CONFIG === 'object' && API_CONFIG.baseURL;
    });

    test('Constants: ROLES defined', () => {
      return ROLES.STUDENT === 'student' && ROLES.TEACHER === 'teacher' && ROLES.ADMIN === 'admin';
    });

    test('Constants: RANK_THRESHOLDS defined', () => {
      return RANK_THRESHOLDS.EXPERT === 1000 && RANK_THRESHOLDS.BEGINNER === 0;
    });

    test('Constants: SESSION_KEY defined', () => {
      return SESSION_KEY === 'studentSession';
    });

    // Session Tests (clear session first)
    clearSession();

    test('Session: isLoggedIn returns false when not logged in', () => {
      return isLoggedIn() === false;
    });

    test('Session: getSession returns null when not logged in', () => {
      return getSession() === null;
    });

    test('Session: saveSession stores session data', () => {
      const userData = {
        id: 999,
        name: 'Test User',
        email: 'test@example.com',
        class_code: 'TEST2025',
        role: 'student'
      };
      const session = saveSession(userData);
      return session.id === 999 && session.name === 'Test User';
    });

    test('Session: isLoggedIn returns true after login', () => {
      return isLoggedIn() === true;
    });

    test('Session: getSession returns session data', () => {
      const session = getSession();
      return session !== null && session.name === 'Test User';
    });

    test('Session: getUserRole returns correct role', () => {
      return getUserRole() === 'student';
    });

    test('Session: hasRole checks role correctly', () => {
      return hasRole('student') === true && hasRole('admin') === false;
    });

    test('Session: clearSession removes session', () => {
      clearSession();
      return getSession() === null && isLoggedIn() === false;
    });

    // Utility Tests
    test('Utilities: calculateRank returns correct rank', () => {
      return calculateRank(0) === 'Beginner' &&
             calculateRank(150) === 'Apprentice' &&
             calculateRank(350) === 'Intermediate' &&
             calculateRank(1000) === 'Expert';
    });

    test('Utilities: calculateProgressPercentage calculates correctly', () => {
      const progress = calculateProgressPercentage(2, 2, 6, 4);
      return progress === 25; // Level 2, 2 steps = (1*4 + 2) / (6*4) = 6/24 = 25%
    });

    test('Utilities: isValidEmail validates emails', () => {
      return isValidEmail('test@example.com') === true &&
             isValidEmail('invalid') === false;
    });

    test('Utilities: isValidPIN validates PINs', () => {
      return isValidPIN('1234') === true &&
             isValidPIN('abc') === false &&
             isValidPIN('12345') === false;
    });

    test('Utilities: capitalize works correctly', () => {
      return capitalize('hello') === 'Hello' && capitalize('WORLD') === 'WORLD';
    });

    test('Utilities: formatRelativeTime formats time', () => {
      const result = formatRelativeTime('2025-10-21T10:00:00Z');
      return typeof result === 'string' && result.length > 0;
    });

    test('Utilities: formatDateTime formats dates', () => {
      const result = formatDateTime('2025-10-21T10:00:00Z');
      return typeof result === 'string' && result.length > 0;
    });

    // Display results
    displayResults();

    console.log('\n‚úÖ Test suite completed!');
    console.log(`Passed: ${results.filter(r => r.pass).length}/${results.length}`);
  </script>
</body>
</html>
